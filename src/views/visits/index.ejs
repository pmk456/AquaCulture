<%- include('../partials/header', { title: 'Visits', currentPage: 'visits', user: user }) %>

<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">Visits Management</h1>
            <p class="text-gray-600 mt-1">Track and manage sales rep visits</p>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow p-4">
        <form class="grid grid-cols-1 md:grid-cols-5 gap-4" method="GET" action="/visits">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Dealer</label>
                <select name="dealer_id" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Dealers</option>
                    <% if (dealers && dealers.length) { %>
                        <% dealers.forEach(d => { %>
                            <option value="<%= d.id %>" <%= filters?.dealer_id == d.id ? 'selected' : '' %>><%= d.name %></option>
                        <% }) %>
                    <% } %>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Rep</label>
                <select name="rep_id" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Reps</option>
                    <% if (reps && reps.length) { %>
                        <% reps.forEach(r => { %>
                            <option value="<%= r.id %>" <%= filters?.rep_id == r.id ? 'selected' : '' %>><%= r.first_name %> <%= r.last_name %></option>
                        <% }) %>
                    <% } %>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Visit Type</label>
                <select name="visit_type" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Types</option>
                    <option value="demo" <%= filters?.visit_type === 'demo' ? 'selected' : '' %>>Demo</option>
                    <option value="sale" <%= filters?.visit_type === 'sale' ? 'selected' : '' %>>Sale</option>
                    <option value="inspect" <%= filters?.visit_type === 'inspect' ? 'selected' : '' %>>Inspect</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                <input type="date" name="start_date" value="<%= filters?.start_date || '' %>" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                <input type="date" name="end_date" value="<%= filters?.end_date || '' %>" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="col-span-full flex justify-end space-x-3">
                <a href="/visits" class="px-4 py-2 border border-gray-300 rounded-lg text-sm text-gray-600 hover:bg-gray-50">Reset</a>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 flex items-center">
                    <i class="fas fa-filter mr-2"></i>Apply
                </button>
            </div>
        </form>
    </div>

    <!-- View Toggle -->
    <div class="flex items-center space-x-2 bg-gray-100 p-1 rounded-lg w-fit">
        <button id="tableViewBtn" class="px-4 py-2 rounded-md text-sm font-medium transition-colors bg-white shadow-sm text-blue-600">
            <i class="fas fa-list mr-2"></i>Table
        </button>
        <button id="cardViewBtn" class="px-4 py-2 rounded-md text-sm font-medium transition-colors text-gray-600 hover:text-gray-800">
            <i class="fas fa-th-large mr-2"></i>Cards
        </button>
    </div>

    <!-- Visits Table View -->
    <div id="tableView" class="bg-white rounded-lg shadow overflow-hidden">
        <div class="overflow-x-auto">
            <table id="visitsTable" class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Visit ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dealer</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rep</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date & Time</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <% if (visits && visits.length) { %>
                        <% visits.forEach(v => { %>
                            <tr class="table-row">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#<%= v.id %></td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900 font-semibold"><%= v.dealer_name %></div>
                                    <div class="text-xs text-gray-500"><%= v.dealer_address %></div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900"><%= v.rep_first_name %> <%= v.rep_last_name %></div>
                                    <div class="text-xs text-gray-500"><%= v.rep_email %></div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 text-xs rounded-full <%= v.visit_type === 'sale' ? 'bg-green-100 text-green-800' : v.visit_type === 'inspect' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800' %> capitalize"><%= v.visit_type %></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    <div><%= new Date(v.start_time).toLocaleDateString() %></div>
                                    <div class="text-xs font-medium"><%= new Date(v.start_time).toLocaleTimeString() %></div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <% if (!v.end_time) { %>
                                        <span class="flex items-center text-xs font-bold text-red-600 animate-pulse">
                                            <span class="w-2 h-2 bg-red-600 rounded-full mr-2"></span>LIVE NOW
                                        </span>
                                    <% } else { %>
                                        <span class="text-xs text-gray-500">Completed</span>
                                    <% } %>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <a href="/visits/<%= v.id %>" class="text-blue-600 hover:text-blue-900 bg-blue-50 px-3 py-1.5 rounded-lg transition-colors">
                                        View Details
                                    </a>
                                </td>
                            </tr>
                        <% }) %>
                    <% } else { %>
                        <tr>
                            <td colspan="7" class="px-6 py-6 text-center text-gray-500">No visits match these filters.</td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Visits Card View (Hidden by default) -->
    <div id="cardView" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <% if (visits && visits.length) { %>
            <% visits.forEach(v => { %>
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-md transition-shadow group">
                    <div class="p-5">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="font-bold text-gray-900 group-hover:text-blue-600 transition-colors"><%= v.dealer_name %></h3>
                                <p class="text-xs text-gray-500 flex items-center mt-1">
                                    <i class="fas fa-map-marker-alt mr-1 text-gray-400"></i>
                                    <%= v.dealer_address %>
                                </p>
                            </div>
                            <span class="px-2 py-1 text-[10px] font-bold uppercase rounded-md tracking-wider <%= v.visit_type === 'sale' ? 'bg-green-100 text-green-700' : v.visit_type === 'inspect' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700' %>">
                                <%= v.visit_type %>
                            </span>
                        </div>

                        <div class="flex items-center space-x-3 mb-4 p-2 bg-gray-50 rounded-lg">
                            <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 text-xs font-bold ring-2 ring-white">
                                <%= (v.rep_first_name ? v.rep_first_name.charAt(0) : '?') %><%= (v.rep_last_name ? v.rep_last_name.charAt(0) : '') %>
                            </div>
                            <div>
                                <p class="text-xs font-semibold text-gray-800"><%= v.rep_first_name || 'Unknown' %> <%= v.rep_last_name || 'Rep' %></p>
                                <p class="text-[10px] text-gray-500"><%= v.rep_email %></p>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-4 text-[11px]">
                            <div>
                                <p class="text-gray-400 mb-1">DATE</p>
                                <p class="font-medium text-gray-700"><%= new Date(v.start_time).toLocaleDateString() %></p>
                            </div>
                            <div>
                                <p class="text-gray-400 mb-1">STARTED</p>
                                <p class="font-medium text-gray-700"><%= new Date(v.start_time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) %></p>
                            </div>
                        </div>

                        <% if (!v.end_time) { %>
                            <div class="mt-4 p-3 bg-red-50 rounded-lg border border-red-100">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="flex items-center text-[10px] font-bold text-red-600 uppercase tracking-widest animate-pulse">
                                        <span class="w-1.5 h-1.5 bg-red-600 rounded-full mr-1.5"></span> Live Tracking Active
                                    </span>
                                    <% 
                                        const repLoc = latestLocations?.find(loc => loc.user_id === v.rep_id);
                                        if (repLoc) { 
                                    %>
                                        <span class="text-[9px] text-gray-500">Updated: <%= new Date(repLoc.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) %></span>
                                    <% } %>
                                </div>
                                <% if (repLoc) { %>
                                    <div class="flex items-center text-[10px] text-gray-600">
                                        <i class="fas fa-location-arrow mr-2 text-red-400"></i>
                                        Rep is at: <span class="ml-1 font-mono"><%= repLoc.latitude.toFixed(4) %>, <%= repLoc.longitude.toFixed(4) %></span>
                                    </div>
                                <% } %>
                            </div>
                        <% } %>
                    </div>
                    <div class="px-5 py-3 bg-gray-50 border-t border-gray-100 flex justify-between items-center">
                        <span class="text-[10px] text-gray-500">#<%= v.id %></span>
                        <a href="/visits/<%= v.id %>" class="text-sm font-semibold text-blue-600 hover:text-blue-800 flex items-center">
                            View Details <i class="fas fa-chevron-right ml-1.5 text-[10px]"></i>
                        </a>
                    </div>
                </div>
            <% }) %>
        <% } else { %>
            <div class="col-span-full py-12 text-center bg-white rounded-xl shadow-sm border border-gray-100">
                <i class="fas fa-calendar-times text-gray-300 text-4xl mb-4"></i>
                <p class="text-gray-500">No visits match these filters.</p>
            </div>
        <% } %>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const tableViewBtn = document.getElementById('tableViewBtn');
    const cardViewBtn = document.getElementById('cardViewBtn');
    const tableView = document.getElementById('tableView');
    const cardView = document.getElementById('cardView');

    function setView(mode) {
        if (mode === 'card') {
            tableView.classList.add('hidden');
            cardView.classList.remove('hidden');
            cardView.classList.add('grid');
            
            cardViewBtn.classList.add('bg-white', 'shadow-sm', 'text-blue-600');
            cardViewBtn.classList.remove('text-gray-600');
            
            tableViewBtn.classList.remove('bg-white', 'shadow-sm', 'text-blue-600');
            tableViewBtn.classList.add('text-gray-600');
            
            localStorage.setItem('visits_view_mode', 'card');
        } else {
            cardView.classList.add('hidden');
            cardView.classList.remove('grid');
            tableView.classList.remove('hidden');
            
            tableViewBtn.classList.add('bg-white', 'shadow-sm', 'text-blue-600');
            tableViewBtn.classList.remove('text-gray-600');
            
            cardViewBtn.classList.remove('bg-white', 'shadow-sm', 'text-blue-600');
            cardViewBtn.classList.add('text-gray-600');
            
            localStorage.setItem('visits_view_mode', 'table');
        }
    }

    tableViewBtn.addEventListener('click', () => setView('table'));
    cardViewBtn.addEventListener('click', () => setView('card'));

    // Load saved preference
    const savedMode = localStorage.getItem('visits_view_mode');
    if (savedMode === 'card') setView('card');
});
</script>

<%- include('../partials/footer') %>

