<%- include('../partials/header', { title: 'Audit Logs', currentPage: 'audit', user: user }) %>

<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">Audit Logs</h1>
            <p class="text-gray-600 mt-1">Track all system activities and changes</p>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow p-4">
        <form id="filterForm" method="GET" action="/audit" class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">User</label>
                <select id="userFilter" name="user_id" form="filterForm" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Users</option>
                    <% if (typeof users !== 'undefined' && users.length > 0) { %>
                        <% users.forEach(u => { %>
                            <option value="<%= u.id %>" <%= req.query && req.query.user_id == u.id ? 'selected' : '' %>>
                                <%= u.first_name %> <%= u.last_name %>
                            </option>
                        <% }); %>
                    <% } %>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Entity</label>
                <select id="entityFilter" name="entity_type" form="filterForm" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Entities</option>
                    <option value="user" <%= req.query && req.query.entity_type === 'user' ? 'selected' : '' %>>User</option>
                    <option value="dealer" <%= req.query && req.query.entity_type === 'dealer' ? 'selected' : '' %>>Dealer</option>
                    <option value="visit" <%= req.query && req.query.entity_type === 'visit' ? 'selected' : '' %>>Visit</option>
                    <option value="territory" <%= req.query && req.query.entity_type === 'territory' ? 'selected' : '' %>>Territory</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Action Type</label>
                <select id="actionFilter" name="action" form="filterForm" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Actions</option>
                    <option value="create" <%= req.query && req.query.action === 'create' ? 'selected' : '' %>>Create</option>
                    <option value="update" <%= req.query && req.query.action === 'update' ? 'selected' : '' %>>Update</option>
                    <option value="delete" <%= req.query && req.query.action === 'delete' ? 'selected' : '' %>>Delete</option>
                    <option value="login" <%= req.query && req.query.action === 'login' ? 'selected' : '' %>>Login</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">From Date</label>
                <input 
                    type="date" 
                    id="fromDate"
                    name="from_date"
                    form="filterForm"
                    value="<%= req.query && req.query.from_date ? req.query.from_date : '' %>"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                >
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">To Date</label>
                <input 
                    type="date" 
                    id="toDate"
                    name="to_date"
                    form="filterForm"
                    value="<%= req.query && req.query.to_date ? req.query.to_date : '' %>"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                >
            </div>
        </div>
        <div class="mt-4 flex justify-end">
            <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                Apply Filters
            </button>
            <a href="/audit" class="ml-2 px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                Reset
            </a>
        </div>
        </form>
    </div>

    <!-- Audit Logs Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="overflow-x-auto">
            <table id="auditTable" class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Entity</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Entity ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <% if (typeof logs !== 'undefined' && logs.length > 0) { %>
                        <% logs.forEach(log => { %>
                            <tr class="table-row">
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    <%= log.created_at ? new Date(log.created_at).toLocaleString() : 'N/A' %>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <% 
                                            const initials = (log.first_name ? log.first_name.charAt(0) : '') + (log.last_name ? log.last_name.charAt(0) : '');
                                            const colors = ['blue', 'green', 'purple', 'red', 'yellow'];
                                            const colorIndex = log.user_id ? log.user_id % colors.length : 0;
                                        %>
                                        <div class="w-8 h-8 bg-<%= colors[colorIndex] %>-600 rounded-full flex items-center justify-center text-white font-semibold text-xs mr-2">
                                            <%= initials || 'S' %>
                                        </div>
                                        <span class="text-sm text-gray-900">
                                            <%= log.first_name && log.last_name ? `${log.first_name} ${log.last_name}` : (log.email || 'System') %>
                                        </span>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <% 
                                        let actionColor = 'blue';
                                        if (log.action === 'create') actionColor = 'green';
                                        else if (log.action === 'delete' || log.action === 'deactivate') actionColor = 'red';
                                        else if (log.action === 'update') actionColor = 'blue';
                                        else if (log.action === 'login') actionColor = 'purple';
                                    %>
                                    <span class="px-2 py-1 text-xs rounded-full bg-<%= actionColor %>-100 text-<%= actionColor %>-800">
                                        <%= log.action.charAt(0).toUpperCase() + log.action.slice(1) %>
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    <%= log.entity_type.charAt(0).toUpperCase() + log.entity_type.slice(1) %>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    <%= log.entity_id || 'N/A' %>
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-500">
                                    <%= log.details || 'No details' %>
                                </td>
                            </tr>
                        <% }); %>
                    <% } else { %>
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-gray-500">No audit logs found</td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>
</div>

<% if (typeof pagination !== 'undefined' && pagination.pages > 1) { %>
<div class="mt-4 flex items-center justify-between">
    <div class="text-sm text-gray-500">
        Showing page <%= pagination.page %> of <%= pagination.pages %> (Total: <%= pagination.total %>)
    </div>
    <div class="flex space-x-2">
        <% if (pagination.page > 1) { %>
            <a href="?page=<%= pagination.page - 1 %>" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                Previous
            </a>
        <% } %>
        <% if (pagination.page < pagination.pages) { %>
            <a href="?page=<%= pagination.page + 1 %>" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                Next
            </a>
        <% } %>
    </div>
</div>
<% } %>

<%- include('../partials/footer') %>

